# 流程引擎 ——流程#

## 1.概述 ##

流程是系统功能的抽象，如果把业务流程用流水线表示，则系统的流程就是流水线的抽象，流程节点则是流水线的操作节点，路由则是流水线的传送带。 
 
流程使用节点对信息进行加工，通过路由将信息传递到下一节点，而规则就是信息加工的工具，这些工具可以在整个流程的任意环节（信息载入，加工节点，路由过程，信息处理完毕）使用。流程本身还提供了一系列方法和属性，这些方法和属性可以控制流程过程中对信息的处理。


## 配置设计 ##

### FLRulesRelated ###

#### 字段说明 ####
- **服务器**`FlowDBServer`复核文本
- **数据库**`FlowDBFile`复核文本
- **视图**`FlowViewName`复核文本 
		
- **目标文档计算规则执行条件**`ComputerConditionsOnTarget` 		
	
	规则执行条件默认在环境文档DocumentContext执行，单如果勾选了此项，则将会在目标文档DocumentTarget上执行条件计算
- **在服务器上运行**`RunOnServer`
	
	选中时规则在服务器上运行。在服务器上执行的规则是以签名者身份执行，具有更高的权限。长被用在对其他文档进行修改或者调度时。
#### 修改记录 ####

- 2013/8/6 18:00:00 添加字段`RunOnServer`复选框	
	

- 2013/8/9 14:45:40 修改**服务器、数据库、视图**三个字段，使用复核文本，方便数据库信息在在配置内填写，同时又可以与原来只支持文本类型的配置相互兼容；		

- 2013/8/9 15:44:08 添加字段`ComputerConditionsOnTarget`
	
	
### FLRulesCopyFields ###
#### 字段说明 ####


- **同名域**`SameFields`多值文本 
	无条件全部拷贝

- **目标字段**`CopyFieldTo`

	- **递增字段**：如果字段结果类似`abc_[_i_]`结果，则要求来源必须是一个字段而非公式，来源公式、条件公式同时支持`[_i]`
	  
		主要用于动态表格

- **类型**`CopyFieldType`多值文本[text、username、number、datetime]

- **条件**`CopyCondition`多值文本-公式

- **来源**`CopyFormula` 多值文本-公式（特定条件下只能为字段）
	
	- **字段变量**：字段下标是指在如果当前文档内具有如果指定字段名称为 `a[_v_]bc`，如果变量是`["x","y","z"]`则会生成 `axbc`,`aybc`,`azbc`.
	   或者 字段名称为`[_v_]`,变量为`["field1","field2"]`,则会生成字段对应子字段。

		主要用于动态流程拆分，如动态表格拆分子流程。
- **操作方式**`CopyOperation`多值文本[G、U、A、D]

	可以是GUAD，G:表示创建或更新，U表示更新（如果不存在则不更新），A表示追加，D表示删除，默认为G
	 
		

#### 修改记录 ####

- 2013/8/8 18:13:18 
		
	多值字段。配置的同名字段，将从当前文档无条件复制到目标文档	

## Base.Rule.lib  ##

**规则基础库，内置规则等**

### ###


## Rule.lib ##
**对应Rule类**

### 方法 ###

- **RunCopyFields**

 	执行字段拷贝规则，同名字段无条件进行NotesItem拷贝，条件字段根据条件计算进行操作以及类型设置

- **RunRelated**

 	执行关联规则，根据关联规则配置，确定是否在服务器上执行。即当`RunOnServer`值为**1**时，关联规则所调用的规则将在服务器上被执行。

- **RunChangeStatus**
	
	执行状态切换规则，根据设置可以进行提交操作、状态切换操作、状态添加操作、状态删除操作

### 全局方法 ###
- **RunRelateRule**

 	执行关联规则，被`Rule`对象的`RunRelated`方法调用，或者通过`RunRelated`方法为委托代理`RunRelateRuleOnServer`在服务器上执行。


### 修改记录 ###

- 2013/10/22 17:24:01 `Base.Rule.Lib`-`RCode` 添加简要表配置处理机制，实现配置的快速存取 
- 2013/8/6 18:00:00 `RunRelateRule`添加全局方法
- 2013/8/6 18:00:00 `RunRelated` 实现对规则在服务器上运行的支持
- 2013/8/8 18:13:18 `RunCopyFields`添加对同名字段拷贝到支持
- 2013/8/9 15:54:31 `RunRelated`添加对规则执行条件在目标文档是计算的支持
- 2013/8/9 16:31:29 `RunCopyFields`修改`text`类型字段拷贝，设置为默认不修改原始类型
- 2013/8/9 17:45:49 `RunCopyFields`添加动态表格类型字段拷贝
- 2013/8/9 17:46:14 `p_CoypField`私有方法新建负责具体字段拷贝处理
- 2013/10/12 10:44:51 `RunRelateRule`添加对提交操作时，环境文档和目标文档都设置为docTarget处理；添加对状态添加、删除、切换等操作时执行配置规则的支持。
## 代理 ##

### RunRelateRuleOnServer ### 2013/8/6 18:00:00 

- 2013/8/6 18:00:00 	

	在服务器上执行规则，改代理有`Rule`对象的`RunRelated`方法通过`agent.runOnServer`调用，作为内置方法使用。执行完成后，调用所传递的文档将被删除。

#### 参数 ####

- **db** :运行的数据库
- **docConfig**：规则配置文档
- **docContext**：当前上下文

### RunRules ###


在相同环境下执行一个或一组规则

#### 参数 ####
- **db** :运行的数据库
- **ruels** :规则列表
- **Conditions**：规则允许条件
- **ConditionFlag**：为true时在目标文档执行规则是否允许的条件
- **docContext**： 规则执行环境
- **docTarget**：规则操作文档

#### 修改记录 ####
- 2013/8/9 15:44:08 
	
	添加ConditionFlag参数，实现对规则执行条件在目标文档上进行计算的控制。

- 2013/8/14 11:03:20 

	添加规则依赖关联机制（规则配置时可以声明依赖），从而是规则与业务的耦合关系更直接，无需先通过调用关联规则再执行具体业务规则。